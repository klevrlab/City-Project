<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Sharks Way AR - Shark Painting Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            position: fixed;
            inset: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        /* Camera feed */
        #video {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        #debug-canvas { display: none; }

        /* Loading overlay */
        #loading {
            position: fixed;
            inset: 0;
            background: rgba(0, 22, 26, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: opacity 0.5s ease;
        }
        #loading.hidden { opacity: 0; pointer-events: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(0, 169, 224, 0.2);
            border-top-color: #00A9E0;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading h2 { font-size: 18px; margin-bottom: 8px; }
        #loading p { font-size: 13px; color: rgba(255,255,255,0.7); text-align: center; max-width: 280px; line-height: 1.5; }
        #loading-status { margin-top: 12px; font-size: 12px; color: #00A9E0; }

        /* Info panel (bottom-right) — from marker-demo */
        #info-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 109, 117, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: white;
            padding: 18px 16px;
            border-radius: 20px;
            z-index: 100;
            width: 140px;
            border: 1px solid rgba(0, 169, 224, 0.3);
            box-shadow: 0 8px 32px rgba(0, 109, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        #info-panel h2 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.3px;
            line-height: 1.3;
        }
        #info-panel p {
            margin: 6px 0;
            font-size: 12px;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.85);
        }
        #info-panel .status-text {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 169, 224, 0.2);
            line-height: 1.3;
        }

        /* Event info slide-in (left) — from marker-demo */
        #event-info {
            position: fixed;
            top: 170px;
            left: -460px;
            transform: translateY(-50%);
            background: rgba(0, 109, 117, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: white;
            padding: 16px 20px;
            border-radius: 16px;
            z-index: 100;
            max-width: 280px;
            border: 1px solid rgba(0, 169, 224, 0.3);
            box-shadow: 0 8px 32px rgba(0, 109, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: left 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        #event-info.visible {
            left: 20px;
        }
        #event-info h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        #event-info .event-details {
            font-size: 13px;
            line-height: 1.6;
        }
        #event-info .event-details p {
            margin: 6px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .icon {
            width: 16px;
            height: 16px;
            vertical-align: middle;
            margin-right: 6px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        .cta-button {
            background: rgba(0, 169, 224, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 169, 224, 0.5);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 169, 224, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            display: block;
            width: 100%;
        }
        .cta-button:active {
            transform: scale(0.95);
            background: rgba(0, 169, 224, 0.5);
        }
        #event-icon {
            width: 45px;
            height: 45px;
            margin: 0 auto 10px;
            display: block;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
            object-fit: contain;
        }

        /* Progress tracker (top-right) — from marker-demo */
        #progress-tracker {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 109, 117, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 16px 18px;
            border-radius: 16px;
            color: white;
            font-size: 11px;
            z-index: 100;
            border: 1px solid rgba(0, 169, 224, 0.3);
            box-shadow: 0 8px 32px rgba(0, 109, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            max-width: 140px;
        }
        #progress-tracker .stop-item {
            margin: 6px 0;
            opacity: 0.5;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        #progress-tracker .stop-item.visited {
            opacity: 1;
            color: #00A9E0;
        }
        #progress-tracker .stop-item .check-icon {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            stroke-width: 2.5;
            fill: none;
        }

        /* 3D Model overlay */
        #model-overlay {
            position: fixed;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 420px;
            height: 420px;
            z-index: 50;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        #model-overlay.visible {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        model-viewer {
            width: 100%;
            height: 100%;
            --poster-color: transparent;
            background: transparent;
        }

        /* Glow ring behind the model */
        #model-glow {
            position: absolute;
            inset: -20px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 169, 224, 0.15) 0%, transparent 70%);
            animation: glowPulse 3s ease-in-out infinite;
            z-index: -1;
        }
        @keyframes glowPulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* Shark name label under model */
        #shark-label {
            position: fixed;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 109, 117, 0.25);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(0, 169, 224, 0.4);
            border-radius: 30px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 700;
            z-index: 60;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 169, 224, 0.2);
        }
        #shark-label.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #shark-label .label-name { color: #00A9E0; }
        #shark-label .label-score { font-size: 11px; color: rgba(255,255,255,0.6); margin-left: 8px; }

        /* Scanning animation */
        #scan-line {
            position: fixed;
            left: 10%; right: 10%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00A9E0, transparent);
            box-shadow: 0 0 12px #00A9E0;
            opacity: 0;
            z-index: 5;
            animation: scanMove 2.5s ease-in-out infinite;
        }
        #scan-line.active { opacity: 0.6; }
        @keyframes scanMove {
            0% { top: 15%; }
            50% { top: 85%; }
            100% { top: 15%; }
        }

        /* Corner brackets */
        .corner {
            position: fixed;
            width: 30px; height: 30px;
            border-color: rgba(0, 169, 224, 0.5);
            border-style: solid;
            border-width: 0;
            z-index: 5;
        }
        .corner.tl { top: 12%; left: 10%; border-top-width: 2px; border-left-width: 2px; border-radius: 4px 0 0 0; }
        .corner.tr { top: 12%; right: 10%; border-top-width: 2px; border-right-width: 2px; border-radius: 0 4px 0 0; }
        .corner.bl { bottom: 12%; left: 10%; border-bottom-width: 2px; border-left-width: 2px; border-radius: 0 0 0 4px; }
        .corner.br { bottom: 12%; right: 10%; border-bottom-width: 2px; border-right-width: 2px; border-radius: 0 0 4px 0; }

        /* Top bar */
        #topbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            padding: 12px 14px;
            background: linear-gradient(to bottom, rgba(0,22,26,0.7) 0%, transparent 100%);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
        }
        #topbar h1 { font-size: 14px; font-weight: 700; }
        #topbar .back {
            color: #00A9E0;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
        }
        #trained-badge {
            margin-left: auto;
            background: rgba(0, 169, 224, 0.25);
            border: 1px solid rgba(0, 169, 224, 0.4);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.05); opacity: 0.9; }
        }

        @media (max-width: 480px) {
            #info-panel {
                bottom: 10px;
                right: 10px;
                width: 120px;
                padding: 14px 12px;
            }
            #info-panel h2 { font-size: 13px; }
            #info-panel p { font-size: 11px; }
            #event-info {
                max-width: 90%;
                padding: 14px 16px;
            }
            #event-info.visible { left: 10px; }
            #event-info h3 { font-size: 15px; }
            #event-info .event-details { font-size: 12px; }
            #progress-tracker {
                top: auto;
                right: auto;
                bottom: 10px;
                left: 10px;
                max-width: 120px;
                padding: 12px 14px;
                font-size: 10px;
            }
            #model-overlay {
                width: 340px;
                height: 340px;
            }
            .cta-button {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Camera feed -->
    <video id="video" autoplay playsinline muted></video>
    <canvas id="debug-canvas" width="224" height="224"></canvas>

    <!-- Loading overlay -->
    <div id="loading">
        <div class="spinner"></div>
        <h2>Sharks Way AR</h2>
        <p>Getting everything ready...</p>
        <div id="loading-status">Please wait</div>
    </div>

    <!-- Top bar -->
    <div id="topbar">
        <a href="./index.html" class="back">&larr;</a>
        <h1>Sharks Way AR</h1>
    </div>

    <!-- 3D Plushie overlay -->
    <div id="model-overlay">
        <div id="model-glow"></div>
        <model-viewer
            id="shark-model-viewer"
            src="./plushie_shark.glb"
            auto-rotate
            rotation-per-second="30deg"
            camera-orbit="0deg 75deg 4m"
            field-of-view="30deg"
            min-field-of-view="20deg"
            max-field-of-view="45deg"
            disable-zoom
            interaction-prompt="none"
            environment-image="neutral"
            shadow-intensity="0.5"
            style="background: transparent; overflow: visible;"
        ></model-viewer>
    </div>

    <!-- Shark label -->
    <div id="shark-label">
        <span class="label-name" id="labelName">Shark Found!</span>
    </div>

    <!-- Info panel (bottom-right) -->
    <div id="info-panel">
        <img id="event-icon" src="./the-big-game.svg" alt="Event" onerror="this.style.display='none'">
        <h2>Sharks Way Tour</h2>
        <p>Point camera at a shark painting</p>
    </div>

    <!-- Event info slide-in -->
    <div id="event-info">
        <h3 id="event-title">Event Loading...</h3>
        <div class="event-details">
            <p id="event-date"></p>
            <p id="event-location"></p>
        </div>
        <div id="sharkey-message" style="font-size: 12px; margin-top: 8px; color: rgba(255,255,255,0.8); line-height: 1.5;"></div>
        <button class="cta-button" id="learn-more">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><path d="M17 2 12 7 7 2"/></svg>
            Learn More
        </button>
        <button class="cta-button" id="dismiss-event" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); margin-top: 6px;">
            Dismiss
        </button>
    </div>

    <!-- Progress tracker -->
    <div id="progress-tracker">
        <div style="font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
            Tour Progress
        </div>
        <div class="stop-item" data-stop="0">
            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>
            SAP Center
        </div>
        <div class="stop-item" data-stop="1">
            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>
            Downtown SJ
        </div>
        <div class="stop-item" data-stop="2">
            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>
            San Pedro Sq
        </div>
    </div>

    <script>
        // ─── CONFIG ───
        const THRESHOLD = 0.55;
        const EMBEDDINGS_URL = './shark-embeddings-browser.json';
        const IMAGE_LIST_URL = './shark-image-list.json';
        const CACHE_KEY = 'shark-embeddings-v5';

        // ─── UI REFS ───
        const ui = {
            video: document.getElementById('video'),
            debugCanvas: document.getElementById('debug-canvas'),
            loading: document.getElementById('loading'),
            loadingStatus: document.getElementById('loading-status'),
            modelOverlay: document.getElementById('model-overlay'),
            sharkLabel: document.getElementById('shark-label'),
            labelName: document.getElementById('labelName'),
            eventInfo: document.getElementById('event-info'),
            infoPanel: document.getElementById('info-panel')
        };

        // ─── STATE ───
        const STATE = {
            model: null,
            stream: null,
            running: false,
            enrolled: [],
            sharkGroups: {},
            lastMatchTime: 0,
            frameCount: 0,
            lastFpsTime: performance.now(),
            recentScores: [],
            ROLLING_N: 5,
            sharkVisible: false,
            dismissedAt: 0,
            currentEventIndex: 0,
            visitedStops: new Set()
        };

        // ─── EVENT DATA (from marker-demo) ───
        const dummyEvents = [
            {
                title: "The Big Game",
                date: "February 9, 2026",
                time: "3:30 PM PST",
                location: "SAP Center, San Jose",
                sharkeyMessage: "Hey there! I'm Sharkey, and this is where the magic happens! SAP Center hosts over 200 events per year. Arrive early to grab some teal gear!",
                icon: "./the-big-game.svg"
            },
            {
                title: "March Madness Watch Party",
                date: "March 15-April 6, 2026",
                time: "Various Times",
                location: "Downtown San Jose",
                sharkeyMessage: "Downtown SJ is buzzing! Over 40 restaurants and bars showing the games. San Pedro Square Market has the best viewing atmosphere!",
                icon: "./march-madness.svg"
            },
            {
                title: "World Cup Viewing",
                date: "June-July 2026",
                time: "Match Times Vary",
                location: "San Pedro Square Market",
                sharkeyMessage: "¡Hola! This historic market has been a gathering place since 1863. Try food from different countries while watching their teams play!",
                icon: "./world-cup.svg"
            }
        ];

        // ─── SOUND ───
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                if (type === 'found') {
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } else if (type === 'tap') {
                    oscillator.frequency.value = 1200;
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }
            } catch (e) { /* ignore audio errors */ }
        }

        // ─── EVENT UI (from marker-demo) ───
        function showEvent(event) {
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-date').innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>${event.date} &bull; ${event.time}`;
            document.getElementById('event-location').innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>${event.location}`;
            document.getElementById('sharkey-message').textContent = event.sharkeyMessage;
            document.getElementById('event-icon').src = event.icon;
            ui.eventInfo.classList.add('visible');

            STATE.visitedStops.add(STATE.currentEventIndex);
            updateProgress();
        }

        function hideEvent() {
            ui.eventInfo.classList.remove('visible');
        }

        function updateProgress() {
            STATE.visitedStops.forEach(index => {
                const stopItem = document.querySelector(`.stop-item[data-stop="${index}"]`);
                if (stopItem) {
                    stopItem.classList.add('visited');
                    const checkIcon = stopItem.querySelector('.check-icon');
                    if (checkIcon) {
                        checkIcon.innerHTML = '<circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>';
                    }
                }
            });
        }

        document.getElementById('learn-more').addEventListener('click', () => {
            playSound('tap');
            alert(`Ready to attend ${dummyEvents[STATE.currentEventIndex].title}?\n\nIn the full version, this would:\n- Show ticket options\n- Add to calendar\n- Share with friends\n- Get directions`);
            STATE.currentEventIndex = (STATE.currentEventIndex + 1) % dummyEvents.length;
            dismissAll();
        });

        document.getElementById('dismiss-event').addEventListener('click', () => {
            playSound('tap');
            dismissAll();
        });

        // ─── EMBEDDING FUNCTIONS ───
        function l2Normalize(vec) {
            let sum = 0;
            for (let i = 0; i < vec.length; i++) sum += vec[i] * vec[i];
            const norm = Math.sqrt(sum);
            if (norm === 0) return vec;
            const out = new Float32Array(vec.length);
            for (let i = 0; i < vec.length; i++) out[i] = vec[i] / norm;
            return out;
        }

        function cosineSimilarity(a, b) {
            let dot = 0;
            for (let i = 0; i < a.length; i++) dot += a[i] * b[i];
            return dot;
        }

        function friendlyName(filename) {
            const m = filename.match(/shark(\d+)/i);
            return m ? `Shark ${parseInt(m[1])}` : filename.replace(/\.[^.]+$/, '');
        }

        function bestMatch(embedding) {
            const sharkScores = {};
            for (const item of STATE.enrolled) {
                const score = cosineSimilarity(embedding, item.embedding);
                const sharkId = friendlyName(item.name);
                if (!sharkScores[sharkId] || score > sharkScores[sharkId].score) {
                    sharkScores[sharkId] = { name: item.name, score };
                }
            }
            let best = { name: null, score: -1 };
            for (const key of Object.keys(sharkScores)) {
                if (sharkScores[key].score > best.score) best = sharkScores[key];
            }
            return best;
        }

        function rollingScore(currentMatch) {
            STATE.recentScores.push({ name: currentMatch.name, score: currentMatch.score });
            if (STATE.recentScores.length > STATE.ROLLING_N) STATE.recentScores.shift();

            const counts = {};
            let topName = null;
            let topCount = 0;
            for (const entry of STATE.recentScores) {
                if (!entry.name) continue;
                counts[entry.name] = (counts[entry.name] || 0) + 1;
                if (counts[entry.name] > topCount) {
                    topCount = counts[entry.name];
                    topName = entry.name;
                }
            }

            let sum = 0, n = 0;
            for (const entry of STATE.recentScores) {
                if (entry.name === topName) { sum += entry.score; n++; }
            }
            return { name: topName, score: n > 0 ? sum / n : 0, confidence: topCount / STATE.ROLLING_N };
        }

        function buildSharkGroups() {
            STATE.sharkGroups = {};
            for (const item of STATE.enrolled) {
                const id = friendlyName(item.name);
                if (!STATE.sharkGroups[id]) STATE.sharkGroups[id] = [];
                STATE.sharkGroups[id].push(item);
            }
        }

        function applyEmbeddings(data) {
            STATE.enrolled = data.map(item => ({
                name: item.name,
                embedding: new Float32Array(item.embedding)
            }));
            buildSharkGroups();
            const sharkCount = Object.keys(STATE.sharkGroups).length;
            console.log(`${sharkCount} sharks loaded`);
        }

        // ─── SILENT FALLBACK HELPERS ───
        function cropAndEmbed(imgEl, sx, sy, sw, sh) {
            const canvas = document.createElement('canvas');
            canvas.width = 224;
            canvas.height = 224;
            canvas.getContext('2d').drawImage(imgEl, sx, sy, sw, sh, 0, 0, 224, 224);
            return tf.tidy(() => {
                const t = tf.browser.fromPixels(canvas);
                return STATE.model.infer(t, true);
            });
        }

        async function silentComputeEmbeddings() {
            const resp = await fetch(IMAGE_LIST_URL);
            if (!resp.ok) return false;
            const imageList = await resp.json();
            const results = [];
            for (const imgPath of imageList) {
                const fileName = imgPath.split('/').pop();
                const img = new Image();
                img.crossOrigin = 'anonymous';
                await new Promise(r => { img.onload = r; img.onerror = r; img.src = './' + imgPath; });
                if (!img.naturalWidth) continue;
                const w = img.naturalWidth, h = img.naturalHeight, m = Math.min(w, h);
                const cx = (w - m) / 2, cy = (h - m) / 2;
                const crops = [[cx,cy,m,m],[0,0,m,m],[w-m,0,m,m],[0,h-m,m,m],[w-m,h-m,m,m]];
                for (const [sx,sy,sw,sh] of crops) {
                    const emb = cropAndEmbed(img, sx, sy, sw, sh);
                    const data = await emb.data();
                    emb.dispose();
                    results.push({ name: fileName, embedding: Array.from(l2Normalize(new Float32Array(data))) });
                }
            }
            if (results.length === 0) return false;
            try { localStorage.setItem(CACHE_KEY, JSON.stringify(results)); } catch (e) {}
            applyEmbeddings(results);
            return true;
        }

        // ─── LOADING ───
        async function loadEmbeddings() {
            ui.loadingStatus.textContent = 'Almost ready...';

            // 1. Try static JSON file (normal path)
            try {
                const resp = await fetch(EMBEDDINGS_URL);
                if (resp.ok) {
                    const data = await resp.json();
                    if (data && data.length > 0) { applyEmbeddings(data); return; }
                }
            } catch (e) {}

            // 2. Try localStorage cache
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    if (data && data.length > 0) { applyEmbeddings(data); return; }
                }
            } catch (e) {}

            // 3. Silent in-browser computation (user sees nothing different)
            const ok = await silentComputeEmbeddings();
            if (!ok) throw new Error('Unable to load shark data');
        }

        async function loadModel() {
            ui.loadingStatus.textContent = 'Preparing camera...';
            await tf.ready();
            STATE.model = await mobilenet.load({ version: 2, alpha: 1.0 });
        }

        async function startCamera() {
            ui.loadingStatus.textContent = 'Starting camera...';
            STATE.stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            ui.video.srcObject = STATE.stream;
            await new Promise(r => { ui.video.onloadedmetadata = r; });
        }

        async function getFrameEmbedding() {
            const vw = ui.video.videoWidth;
            const vh = ui.video.videoHeight;
            const minDim = Math.min(vw, vh);
            const sx = (vw - minDim) / 2;
            const sy = (vh - minDim) / 2;
            const ctx = ui.debugCanvas.getContext('2d', { willReadFrequently: true });
            ctx.drawImage(ui.video, sx, sy, minDim, minDim, 0, 0, 224, 224);
            const emb = tf.tidy(() => {
                const t = tf.browser.fromPixels(ui.debugCanvas);
                return STATE.model.infer(t, true);
            });
            const data = await emb.data();
            emb.dispose();
            return l2Normalize(new Float32Array(data));
        }

        // ─── SHARK FOUND / LOST ───
        function onSharkFound(name, score) {
            if (STATE.sharkVisible) return; // already showing
            STATE.sharkVisible = true;
            STATE.lastMatchTime = performance.now();

            // Show 3D model
            ui.modelOverlay.classList.add('visible');

            // Show label
            ui.labelName.textContent = 'Sharkey';
            ui.sharkLabel.classList.add('visible');

            // Show event info + sound
            showEvent(dummyEvents[STATE.currentEventIndex]);
            playSound('found');

        }

        function onSharkLost() {
            // Do nothing — shark stays until user dismisses
        }

        function dismissAll() {
            STATE.sharkVisible = false;
            STATE.dismissedAt = performance.now();
            STATE.recentScores = [];
            ui.modelOverlay.classList.remove('visible');
            ui.sharkLabel.classList.remove('visible');
            hideEvent();
        }

        // ─── MAIN LOOP ───
        async function loop() {
            if (!STATE.running) return;

            try {
                if (!STATE.model || !STATE.stream || STATE.enrolled.length === 0) {
                    requestAnimationFrame(loop);
                    return;
                }

                const embedding = await getFrameEmbedding();
                const rawMatch = bestMatch(embedding);
                const smoothed = rollingScore(rawMatch);

                const cooldownOver = performance.now() - STATE.dismissedAt > 3000;
                if (cooldownOver && smoothed.name && smoothed.score >= THRESHOLD && smoothed.confidence >= 0.4) {
                    STATE.lastMatchTime = performance.now();
                    onSharkFound(smoothed.name, smoothed.score);
                } else {
                    onSharkLost();
                }
            } catch (e) {
                console.error('Loop error:', e);
            }

            requestAnimationFrame(loop);
        }

        // ─── INIT ───
        async function init() {
            try {
                await loadModel();
                await loadEmbeddings();
                await startCamera();

                ui.loading.classList.add('hidden');

                STATE.running = true;
                loop();
            } catch (e) {
                ui.loadingStatus.textContent = 'Something went wrong. Please refresh.';
                console.error(e);
            }
        }

        init();
    </script>
</body>
</html>
