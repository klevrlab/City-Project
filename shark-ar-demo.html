<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Sharks Way AR - Shark Painting Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            position: fixed;
            inset: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        /* Camera feed */
        #video {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        #debug-canvas { display: none; }

        /* Loading overlay */
        #loading {
            position: fixed;
            inset: 0;
            background: rgba(0, 22, 26, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: opacity 0.5s ease;
        }
        #loading.hidden { opacity: 0; pointer-events: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(0, 169, 224, 0.2);
            border-top-color: #00A9E0;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading h2 { font-size: 18px; margin-bottom: 8px; }
        #loading p { font-size: 13px; color: rgba(255,255,255,0.7); text-align: center; max-width: 280px; line-height: 1.5; }
        #loading-status { margin-top: 12px; font-size: 12px; color: #00A9E0; }

        /* Info panel (bottom-right) — from marker-demo */
        #info-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 109, 117, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: white;
            padding: 18px 16px;
            border-radius: 20px;
            z-index: 100;
            width: 140px;
            border: 1px solid rgba(0, 169, 224, 0.3);
            box-shadow: 0 8px 32px rgba(0, 109, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        #info-panel h2 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.3px;
            line-height: 1.3;
        }
        #info-panel p {
            margin: 6px 0;
            font-size: 12px;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.85);
        }
        #info-panel .status-text {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 169, 224, 0.2);
            line-height: 1.3;
        }

        /* Event info slide-in (left) — from marker-demo */
        #event-info {
            position: fixed;
            top: 170px;
            left: -460px;
            transform: translateY(-50%);
            background: rgba(0, 109, 117, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: white;
            padding: 16px 20px;
            border-radius: 16px;
            z-index: 100;
            max-width: 280px;
            border: 1px solid rgba(0, 169, 224, 0.3);
            box-shadow: 0 8px 32px rgba(0, 109, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: left 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        #event-info.visible {
            left: 20px;
        }
        #event-info h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        #event-info .event-details {
            font-size: 13px;
            line-height: 1.6;
        }
        #event-info .event-details p {
            margin: 6px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .icon {
            width: 16px;
            height: 16px;
            vertical-align: middle;
            margin-right: 6px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        .cta-button {
            background: rgba(0, 169, 224, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 169, 224, 0.5);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 169, 224, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            display: block;
            width: 100%;
        }
        .cta-button:active {
            transform: scale(0.95);
            background: rgba(0, 169, 224, 0.5);
        }
        #event-icon {
            width: 45px;
            height: 45px;
            margin: 0 auto 10px;
            display: block;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
            object-fit: contain;
        }

        /* Progress tracker (top-right) — from marker-demo */
        #progress-tracker {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 109, 117, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 16px 18px;
            border-radius: 16px;
            color: white;
            font-size: 11px;
            z-index: 100;
            border: 1px solid rgba(0, 169, 224, 0.3);
            box-shadow: 0 8px 32px rgba(0, 109, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            max-width: 140px;
        }
        #progress-tracker .stop-item {
            margin: 6px 0;
            opacity: 0.5;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        #progress-tracker .stop-item.visited {
            opacity: 1;
            color: #00A9E0;
        }
        #progress-tracker .stop-item .check-icon {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            stroke-width: 2.5;
            fill: none;
        }

        /* 3D Model overlay */
        #model-overlay {
            position: fixed;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 420px;
            height: 420px;
            z-index: 50;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        #model-overlay.visible {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        model-viewer {
            width: 100%;
            height: 100%;
            --poster-color: transparent;
            background: transparent;
        }

        /* Glow ring behind the model */
        #model-glow {
            position: absolute;
            inset: -20px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 169, 224, 0.15) 0%, transparent 70%);
            animation: glowPulse 3s ease-in-out infinite;
            z-index: -1;
        }
        @keyframes glowPulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* Shark name label under model */
        #shark-label {
            position: fixed;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 109, 117, 0.25);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(0, 169, 224, 0.4);
            border-radius: 30px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 700;
            z-index: 60;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 169, 224, 0.2);
        }
        #shark-label.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #shark-label .label-name { color: #00A9E0; }
        #shark-label .label-score { font-size: 11px; color: rgba(255,255,255,0.6); margin-left: 8px; }

        /* Scanning animation */
        #scan-line {
            position: fixed;
            left: 10%; right: 10%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00A9E0, transparent);
            box-shadow: 0 0 12px #00A9E0;
            opacity: 0;
            z-index: 5;
            animation: scanMove 2.5s ease-in-out infinite;
        }
        #scan-line.active { opacity: 0.6; }
        @keyframes scanMove {
            0% { top: 15%; }
            50% { top: 85%; }
            100% { top: 15%; }
        }

        /* Corner brackets */
        .corner {
            position: fixed;
            width: 30px; height: 30px;
            border-color: rgba(0, 169, 224, 0.5);
            border-style: solid;
            border-width: 0;
            z-index: 5;
        }
        .corner.tl { top: 12%; left: 10%; border-top-width: 2px; border-left-width: 2px; border-radius: 4px 0 0 0; }
        .corner.tr { top: 12%; right: 10%; border-top-width: 2px; border-right-width: 2px; border-radius: 0 4px 0 0; }
        .corner.bl { bottom: 12%; left: 10%; border-bottom-width: 2px; border-left-width: 2px; border-radius: 0 0 0 4px; }
        .corner.br { bottom: 12%; right: 10%; border-bottom-width: 2px; border-right-width: 2px; border-radius: 0 0 4px 0; }

        /* Top bar */
        #topbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            padding: 12px 14px;
            background: linear-gradient(to bottom, rgba(0,22,26,0.7) 0%, transparent 100%);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
        }
        #topbar h1 { font-size: 14px; font-weight: 700; }
        #topbar .back {
            color: #00A9E0;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
        }
        #topbar .top-btn {
            background: rgba(0, 169, 224, 0.25);
            border: 1px solid rgba(0, 169, 224, 0.4);
            color: #fff;
            border-radius: 20px;
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }
        #topbar .top-btn:disabled {
            opacity: 0.45;
            cursor: default;
        }
        #topbar .top-btn.top-btn--warn {
            border-color: rgba(255, 177, 0, 0.6);
            background: rgba(255, 177, 0, 0.18);
        }
        #trained-badge {
            margin-left: auto;
            background: rgba(0, 169, 224, 0.25);
            border: 1px solid rgba(0, 169, 224, 0.4);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.05); opacity: 0.9; }
        }

        @media (max-width: 480px) {
            #info-panel {
                bottom: 10px;
                right: 10px;
                width: 120px;
                padding: 14px 12px;
            }
            #info-panel h2 { font-size: 13px; }
            #info-panel p { font-size: 11px; }
            #event-info {
                max-width: 90%;
                padding: 14px 16px;
            }
            #event-info.visible { left: 10px; }
            #event-info h3 { font-size: 15px; }
            #event-info .event-details { font-size: 12px; }
            #progress-tracker {
                top: auto;
                right: auto;
                bottom: 10px;
                left: 10px;
                max-width: 120px;
                padding: 12px 14px;
                font-size: 10px;
            }
            #model-overlay {
                width: 340px;
                height: 340px;
            }
            .cta-button {
                padding: 10px 16px;
                font-size: 13px;
            }
            #topbar .top-btn {
                padding: 5px 8px;
                font-size: 10px;
            }
        }

        /* Shark + video plane overlay (fallback, no AR) */
        #shark-plane-overlay {
            position: fixed;
            inset: 0;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        #shark-plane-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #shark-plane-overlay a-scene {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        #shark-plane-overlay canvas {
            background: transparent !important;
        }

        /* WebXR plane AR surface */
        #plane-ar-overlay {
            position: fixed;
            inset: 0;
            z-index: 45;
            display: none;
            pointer-events: none;
        }
        #plane-ar-overlay.visible {
            display: block;
        }
        #plane-ar-overlay canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }
        #plane-ar-hint {
            position: absolute;
            left: 50%;
            bottom: 22px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.62);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 12px;
            border-radius: 14px;
            font-size: 12px;
            white-space: nowrap;
        }

        #caveman-debug {
            position: fixed;
            top: 56px;
            left: 10px;
            z-index: 190;
            width: min(92vw, 360px);
            background: rgba(0, 0, 0, 0.75);
            border: 1px solid rgba(0, 255, 255, 0.55);
            color: #d9ffff;
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 11px;
            line-height: 1.35;
            white-space: pre-wrap;
            pointer-events: none;
        }
        #rig0-tuner {
            position: fixed;
            top: 176px;
            left: 10px;
            z-index: 191;
            width: min(92vw, 360px);
            background: rgba(8, 12, 18, 0.84);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: #fff;
            border-radius: 10px;
            padding: 10px;
            font-size: 12px;
            line-height: 1.35;
        }
        #rig0-tuner .row {
            display: grid;
            grid-template-columns: 16px 1fr 52px;
            gap: 8px;
            align-items: center;
            margin-top: 6px;
        }
        #rig0-tuner input[type="range"] {
            width: 100%;
        }
        #rig0-tuner .val {
            text-align: right;
            color: #8fefff;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- Camera feed -->
    <video id="video" autoplay playsinline muted></video>
    <canvas id="debug-canvas" width="224" height="224"></canvas>

    <!-- Loading overlay -->
    <div id="loading">
        <div class="spinner"></div>
        <h2>Sharks Way AR</h2>
        <p>Getting everything ready...</p>
        <div id="loading-status">Please wait</div>
    </div>

    <!-- Top bar -->
    <div id="topbar">
        <a href="./index.html" class="back">&larr;</a>
        <h1>Sharks Way AR</h1>
        <button id="start-plane-ar-btn" class="top-btn" type="button">Start Plane AR</button>
        <button id="reanchor-btn" class="top-btn top-btn--warn" type="button" style="display:none;">Re-anchor</button>
        <button id="debug-force-btn" class="top-btn" type="button">Force Animation</button>
    </div>
    <div id="caveman-debug" hidden></div>
    <div id="rig0-tuner" hidden>
        <strong>Rig0 Position Tuner</strong>
        <div class="row"><span>X</span><input id="rig0-x" type="range" min="-2.00" max="2.00" step="0.01" value="0.00"><span class="val" id="rig0-x-val">0.00</span></div>
        <div class="row"><span>Y</span><input id="rig0-y" type="range" min="-1.00" max="2.00" step="0.01" value="0.40"><span class="val" id="rig0-y-val">0.40</span></div>
        <div class="row"><span>Z</span><input id="rig0-z" type="range" min="-4.00" max="2.00" step="0.01" value="0.00"><span class="val" id="rig0-z-val">0.00</span></div>
    </div>

    <!-- 3D Plushie overlay -->
    <div id="model-overlay">
        <div id="model-glow"></div>
        <model-viewer
            id="shark-model-viewer"
            src="./assets/shark.glb"
            auto-rotate
            rotation-per-second="30deg"
            camera-orbit="0deg 75deg 4m"
            field-of-view="30deg"
            min-field-of-view="20deg"
            max-field-of-view="45deg"
            disable-zoom
            interaction-prompt="none"
            environment-image="neutral"
            shadow-intensity="0.5"
            style="background: transparent; overflow: visible;"
        ></model-viewer>
    </div>

    <!-- Shark label -->
    <div id="shark-label">
        <span class="label-name" id="labelName">Shark Found!</span>
    </div>

    <!-- Info panel (bottom-right) -->
    <div id="info-panel">
        <img id="event-icon" src="./the-big-game.svg" alt="Event" onerror="this.style.display='none'">
        <h2>Sharks Way Tour</h2>
        <p>Point camera at a shark painting</p>
    </div>

    <!-- Event info slide-in -->
    <div id="event-info">
        <h3 id="event-title">Event Loading...</h3>
        <div class="event-details">
            <p id="event-date"></p>
            <p id="event-location"></p>
        </div>
        <div id="sharkey-message" style="font-size: 12px; margin-top: 8px; color: rgba(255,255,255,0.8); line-height: 1.5;"></div>
        <button class="cta-button" id="learn-more">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><path d="M17 2 12 7 7 2"/></svg>
            Learn More
        </button>
        <button class="cta-button" id="dismiss-event" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); margin-top: 6px;">
            Dismiss
        </button>
    </div>

    <!-- Progress tracker -->
    <div id="progress-tracker">
        <div style="font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
            Tour Progress
        </div>
        <div class="stop-item" data-stop="0">
            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>
            SAP Center
        </div>
        <div class="stop-item" data-stop="1">
            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>
            Downtown SJ
        </div>
        <div class="stop-item" data-stop="2">
            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>
            San Pedro Sq
        </div>
    </div>

    <!-- Shark animation + video plane (fallback mode) -->
    <div id="shark-plane-overlay">
        <a-scene id="mural-shark-scene" embedded vr-mode-ui="enabled: false"
            renderer="alpha: true; antialias: true; colorManagement: true;">
            <a-assets>
                <video id="videoTexture" src="./assets/video.mp4" autoplay loop muted playsinline crossorigin="anonymous" preload="auto"></video>
                <a-asset-item id="sharkModel1" src="./MARIA_SHARK_ANIMATED.glb"></a-asset-item>
                <a-asset-item id="sharkModel2" src="./SHAUN_SHARK_ANIMATED.glb"></a-asset-item>
            </a-assets>
            <a-entity id="mural-shark-root" mural-shark-content></a-entity>
            <a-entity camera="fov: 55; zoom: 1.0" position="0 1.35 3.1" look-controls="enabled: false"></a-entity>
            <a-entity light="type: ambient; intensity: 0.9; color: #ffffff"></a-entity>
            <a-entity light="type: directional; intensity: 1.1; color: #ffffff" position="1 2 1"></a-entity>
        </a-scene>
    </div>

    <!-- WebXR Plane AR canvas -->
    <div id="plane-ar-overlay">
        <div id="plane-ar-hint">Move phone slowly to find a surface</div>
    </div>

    <script>
        const CAVEMAN_DEBUG = true;
        const CAVEMAN_FREEZE = false;
        const CAVEMAN_RIG0_TUNER = true;

        function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
        function getResponsiveScale() {
            const minDim = Math.min(window.innerWidth || 0, window.innerHeight || 0);
            if (minDim <= 420) return 0.6;
            if (minDim <= 720) return 0.8;
            return 1.0;
        }
        function applyVideoPlaneLayout(opts) {
            const { videoEl, planeEl, shadowEl } = opts || {};
            if (!planeEl) return;
            const scale = getResponsiveScale();
            const baseHeight = 1.0 * scale;
            const aspect = (videoEl && videoEl.videoWidth && videoEl.videoHeight)
                ? (videoEl.videoWidth / videoEl.videoHeight) : 1;
            const width = clamp(baseHeight * aspect, 0.9 * scale, 1.6 * scale);
            const posX = 0.85 * scale, posZ = -0.85 * scale, videoY = 0.12 * scale;
            const shadowY = 0.01, shadowPad = 0.18 * scale;
            planeEl.setAttribute('position', `${posX} ${videoY} ${posZ}`);
            planeEl.setAttribute('width', width);
            planeEl.setAttribute('height', baseHeight);
            if (shadowEl) {
                shadowEl.setAttribute('position', `${posX} ${shadowY} ${posZ}`);
                shadowEl.setAttribute('width', width + shadowPad);
                shadowEl.setAttribute('height', baseHeight + shadowPad);
            }
        }

        if (typeof AFRAME !== 'undefined') {
            AFRAME.registerComponent('video-fact-cycle', {
                schema: {
                    intervalMs: { type: 'number', default: 8000 },
                    visibleMs: { type: 'number', default: 4000 },
                    animMs: { type: 'number', default: 500 },
                    videoId: { type: 'string', default: 'videoTexture' },
                    shadowSelector: { type: 'string', default: '.video-shadow' }
                },
                init: function () {
                    this._timer = null;
                    this._cycle = this._cycle.bind(this);
                    this.shadowEl = this.el.parentElement && this.data.shadowSelector
                        ? this.el.parentElement.querySelector(this.data.shadowSelector) : null;
                },
                playOnce: function () { this._cycle(); },
                stop: function () {
                    if (this._timer) { clearInterval(this._timer); this._timer = null; }
                    this.el.removeAttribute('animation__factIn');
                    this.el.removeAttribute('animation__factOut');
                    this.el.setAttribute('scale', '0.001 0.001 0.001');
                    if (this.shadowEl) {
                        this.shadowEl.removeAttribute('animation__shadowIn');
                        this.shadowEl.removeAttribute('animation__shadowOut');
                        this.shadowEl.setAttribute('scale', '0.001 0.001 0.001');
                    }
                    const videoEl = document.getElementById(this.data.videoId);
                    if (videoEl) videoEl.pause();
                },
                _cycle: function () {
                    const videoEl = document.getElementById(this.data.videoId);
                    if (videoEl) {
                        const duration = Number.isFinite(videoEl.duration) ? videoEl.duration : 0;
                        if (duration > 4) {
                            const maxStart = Math.max(duration - 4, 0.1);
                            videoEl.currentTime = Math.random() * maxStart;
                        }
                        videoEl.play().catch(function () {});
                    }
                    this.el.setAttribute('scale', '0.001 0.001 0.001');
                    this.el.setAttribute('animation__factIn', {
                        property: 'scale', from: '0.001 0.001 0.001', to: '1 1 1',
                        dur: this.data.animMs, easing: 'easeOutBack'
                    });
                    if (this.shadowEl) {
                        this.shadowEl.setAttribute('scale', '0.001 0.001 0.001');
                        this.shadowEl.setAttribute('animation__shadowIn', {
                            property: 'scale', from: '0.001 0.001 0.001', to: '1 1 1',
                            dur: this.data.animMs, easing: 'easeOutBack'
                        });
                    }
                    const self = this;
                    setTimeout(function () {
                        self.el.setAttribute('animation__factOut', {
                            property: 'scale', from: '1 1 1', to: '0.001 0.001 0.001',
                            dur: self.data.animMs, easing: 'easeInCubic'
                        });
                        if (self.shadowEl) {
                            self.shadowEl.setAttribute('animation__shadowOut', {
                                property: 'scale', from: '1 1 1', to: '0.001 0.001 0.001',
                                dur: self.data.animMs, easing: 'easeInCubic'
                            });
                        }
                        if (videoEl) videoEl.pause();
                    }, this.data.visibleMs);
                }
            });

            AFRAME.registerComponent('mural-shark-content', {
                init: function () {
                    const self = this;
                    self.root = self.el;
                    self.cyclingActive = false;
                    self.currentSharkIndex = 0;
                    self.sharkTimers = [];
                    self.modelDebug = [{ loaded: false, mesh: false, size: '-' }, { loaded: false, mesh: false, size: '-' }];
                    self.debugEl = document.getElementById('caveman-debug');
                    self.debugText = '';
                    self.root.innerHTML = [
                        '<a-plane class="video-shadow" visible="false" position="0.85 0.01 -0.85" rotation="-90 0 0" width="1.2" height="1.2" material="color: #000000; opacity: 0.22; transparent: true; depthWrite: false"></a-plane>',
                        '<a-plane class="shark-video-plane" visible="false" position="0.85 0.05 -0.85" rotation="-90 0 0" width="1.0" height="1.0" material="shader: flat; src: #videoTexture; transparent: true; color: #000000"></a-plane>',
                        '<a-entity class="shark-rig-1" visible="false" position="0 1.0 0" rotation="0 0 0" scale="0.55 0.55 0.55">',
                        '  <a-box class="debug-proxy" visible="false" depth="0.8" height="0.35" width="1.6" material="color: #ff00ff; opacity: 0.95"></a-box>',
                        '  <a-circle class="shark-shadow" radius="0.75" position="4 -1.50 0" rotation="-90 0 0" material="color: #000000; opacity: 0.25; transparent: true; side: double"></a-circle>',
                        '  <a-entity class="shark-model-1" gltf-model="#sharkModel1" position="0 -0.85 0" rotation="0 -90 0" animation-mixer="loop: repeat; timeScale: 1.0"></a-entity>',
                        '</a-entity>',
                        '<a-entity class="shark-rig-2" visible="false" position="0 1.0 0" rotation="0 0 0" scale="0.55 0.55 0.55">',
                        '  <a-box class="debug-proxy" visible="false" depth="0.8" height="0.35" width="1.6" material="color: #00ff00; opacity: 0.95"></a-box>',
                        '  <a-circle class="shark-shadow" radius="0.75" position="0 -1.50 -4" rotation="-90 0 0" material="color: #000000; opacity: 0.25; transparent: true; side: double"></a-circle>',
                        '  <a-entity class="shark-model-2" gltf-model="#sharkModel2" position="0 -0.85 0" rotation="0 180 0" animation-mixer="loop: repeat; timeScale: 1.0"></a-entity>',
                        '</a-entity>'
                    ].join('');
                    self.sharkVideoPlane = self.root.querySelector('.shark-video-plane');
                    self.sharkVideoShadow = self.root.querySelector('.video-shadow');
                    if (self.sharkVideoPlane) {
                        self.sharkVideoPlane.setAttribute('video-fact-cycle', 'intervalMs: 8000; visibleMs: 4000; animMs: 500; videoId: videoTexture');
                    }
                    self.sharkRigs = [self.root.querySelector('.shark-rig-1'), self.root.querySelector('.shark-rig-2')];
                    self.sharkModels = [self.root.querySelector('.shark-model-1'), self.root.querySelector('.shark-model-2')];
                    self.debugProxies = Array.from(self.root.querySelectorAll('.debug-proxy'));
                    if (CAVEMAN_DEBUG) {
                        (self.debugProxies || []).forEach(function (proxy) { proxy.setAttribute('visible', true); });
                        (self.sharkRigs || []).forEach(function (rig) {
                            if (!rig || !rig.object3D || typeof THREE === 'undefined') return;
                            if (rig.object3D.getObjectByName('debug-axes')) return;
                            var axes = new THREE.AxesHelper(0.8);
                            axes.name = 'debug-axes';
                            rig.object3D.add(axes);
                        });
                        if (self.debugEl) self.debugEl.hidden = false;
                    }
                    self.updateDebug = function (extra) {
                        if (!CAVEMAN_DEBUG || !self.debugEl) return;
                        var r0 = (self.sharkRigs && self.sharkRigs[0]) ? self.sharkRigs[0].getAttribute('position') : null;
                        var r1 = (self.sharkRigs && self.sharkRigs[1]) ? self.sharkRigs[1].getAttribute('position') : null;
                        var lines = [
                            'CAVEMAN DEBUG ON',
                            'cycling=' + self.cyclingActive + ' idx=' + self.currentSharkIndex,
                            'rig0 vis=' + !!(self.sharkRigs && self.sharkRigs[0] && self.sharkRigs[0].getAttribute('visible')) + ' pos=' + (r0 ? `${r0.x.toFixed(2)},${r0.y.toFixed(2)},${r0.z.toFixed(2)}` : '-'),
                            'rig1 vis=' + !!(self.sharkRigs && self.sharkRigs[1] && self.sharkRigs[1].getAttribute('visible')) + ' pos=' + (r1 ? `${r1.x.toFixed(2)},${r1.y.toFixed(2)},${r1.z.toFixed(2)}` : '-'),
                            `m1 loaded=${self.modelDebug[0].loaded} mesh=${self.modelDebug[0].mesh} bbox=${self.modelDebug[0].size}`,
                            `m2 loaded=${self.modelDebug[1].loaded} mesh=${self.modelDebug[1].mesh} bbox=${self.modelDebug[1].size}`,
                            extra || ''
                        ];
                        self.debugEl.textContent = lines.filter(Boolean).join('\n');
                    };
                    self.sharkModels.forEach(function (modelEl, idx) {
                        if (!modelEl) return;
                        modelEl.addEventListener('model-loaded', function () {
                            var mesh = modelEl.getObject3D('mesh');
                            self.modelDebug[idx].loaded = true;
                            self.modelDebug[idx].mesh = !!mesh;
                            if (mesh && typeof THREE !== 'undefined') {
                                try {
                                    var box = new THREE.Box3().setFromObject(mesh);
                                    var size = new THREE.Vector3();
                                    box.getSize(size);
                                    self.modelDebug[idx].size = `${size.x.toFixed(2)}x${size.y.toFixed(2)}x${size.z.toFixed(2)}`;

                                    // Recenter model around rig origin once so rig coords are meaningful.
                                    if (!modelEl.dataset.centered) {
                                        var center = new THREE.Vector3();
                                        box.getCenter(center);
                                        var basePos = modelEl.getAttribute('position') || { x: 0, y: 0, z: 0 };
                                        var px = Number(basePos.x || 0) - center.x;
                                        var py = Number(basePos.y || 0) - center.y;
                                        var pz = Number(basePos.z || 0) - center.z;
                                        modelEl.setAttribute('position', `${px} ${py} ${pz}`);
                                        modelEl.dataset.centered = 'true';
                                    }
                                } catch (e) {
                                    self.modelDebug[idx].size = 'bbox_err';
                                }
                            }
                            console.log('[CAVEMAN] model-loaded', idx, self.modelDebug[idx]);
                            self.updateDebug('model-loaded ' + idx);
                        });
                        modelEl.addEventListener('model-error', function (e) {
                            self.modelDebug[idx].loaded = false;
                            self.modelDebug[idx].mesh = false;
                            self.modelDebug[idx].size = 'load_err';
                            console.warn('[CAVEMAN] model-error', idx, e && e.detail);
                            self.updateDebug('model-error ' + idx);
                        });
                    });
                    self.updateVideoLayout = function () {
                        applyVideoPlaneLayout({
                            videoEl: document.getElementById('videoTexture'),
                            planeEl: self.sharkVideoPlane,
                            shadowEl: self.sharkVideoShadow
                        });
                    };
                    self.updateVideoLayout();
                    window.addEventListener('resize', self.updateVideoLayout);
                    self.updateDebug('init');
                },
                show: function () {
                    var self = this;
                    if (CAVEMAN_DEBUG && CAVEMAN_RIG0_TUNER) {
                        if (self.sharkVideoPlane) self.sharkVideoPlane.setAttribute('visible', false);
                        if (self.sharkVideoShadow) self.sharkVideoShadow.setAttribute('visible', false);
                        (self.sharkRigs || []).forEach(function (rig) {
                            if (!rig) return;
                            rig.removeAttribute('animation__swimPass');
                            rig.removeAttribute('animation__bob');
                            rig.setAttribute('visible', false);
                        });
                        self.cyclingActive = false;
                        var rig0 = (self.sharkRigs || [])[0];
                        if (rig0) {
                            if (self.rig0TunerHideTimer) clearTimeout(self.rig0TunerHideTimer);
                            rig0.setAttribute('visible', true);
                            rig0.setAttribute('rotation', '0 270 0');
                            rig0.setAttribute('scale', '0.85 0.85 0.85');
                            rig0.setAttribute('position', `${RIG0_TUNER.x.toFixed(2)} ${RIG0_TUNER.y.toFixed(2)} 2.50`);
                            rig0.setAttribute('animation__swimPass', {
                                property: 'position',
                                from: `${RIG0_TUNER.x.toFixed(2)} ${RIG0_TUNER.y.toFixed(2)} 2.50`,
                                to: `${RIG0_TUNER.x.toFixed(2)} ${RIG0_TUNER.y.toFixed(2)} -15.00`,
                                dur: 3600,
                                easing: 'easeInOutSine'
                            });
                            var model0 = (self.sharkModels || [])[0];
                            if (model0) {
                                var mesh0 = model0.getObject3D('mesh');
                                if (mesh0) {
                                    mesh0.traverse(function (child) {
                                        if (!child.isMesh || !child.material) return;
                                        var mats = Array.isArray(child.material) ? child.material : [child.material];
                                        mats.forEach(function (mat) {
                                            mat.transparent = true;
                                            mat.opacity = 1.0;
                                            mat.needsUpdate = true;
                                        });
                                    });
                                }
                            }
                            setTimeout(function () {
                                var modelAtFade = (self.sharkModels || [])[0];
                                if (!modelAtFade) return;
                                var meshAtFade = modelAtFade.getObject3D('mesh');
                                if (!meshAtFade) return;
                                var fadeStart = performance.now();
                                var fadeDuration = 650;
                                function fadeStep(now) {
                                    var t = Math.min((now - fadeStart) / fadeDuration, 1);
                                    var opacity = 1 - t;
                                    meshAtFade.traverse(function (child) {
                                        if (!child.isMesh || !child.material) return;
                                        var mats = Array.isArray(child.material) ? child.material : [child.material];
                                        mats.forEach(function (mat) {
                                            mat.transparent = true;
                                            mat.opacity = opacity;
                                            mat.needsUpdate = true;
                                        });
                                    });
                                    if (t < 1) requestAnimationFrame(fadeStep);
                                }
                                requestAnimationFrame(fadeStep);
                            }, 3400);
                            self.rig0TunerHideTimer = setTimeout(function () {
                                rig0.removeAttribute('animation__swimPass');
                                rig0.setAttribute('visible', false);
                                var modelAtHide = (self.sharkModels || [])[0];
                                if (modelAtHide) {
                                    var meshAtHide = modelAtHide.getObject3D('mesh');
                                    if (meshAtHide) {
                                        meshAtHide.traverse(function (child) {
                                            if (!child.isMesh || !child.material) return;
                                            var mats = Array.isArray(child.material) ? child.material : [child.material];
                                            mats.forEach(function (mat) {
                                                mat.transparent = true;
                                                mat.opacity = 1.0;
                                                mat.needsUpdate = true;
                                            });
                                        });
                                    }
                                }
                            }, 4100);
                        }
                        self.updateDebug('show: rig0 tuner mode');
                        return;
                    }
                    if (CAVEMAN_DEBUG && CAVEMAN_FREEZE) {
                        if (self.sharkVideoPlane) self.sharkVideoPlane.setAttribute('visible', false);
                        if (self.sharkVideoShadow) self.sharkVideoShadow.setAttribute('visible', false);
                        (self.sharkRigs || []).forEach(function (rig, i) {
                            if (!rig) return;
                            rig.removeAttribute('animation__swimPass');
                            rig.removeAttribute('animation__bob');
                            if (i === 0) {
                                rig.setAttribute('visible', true);
                                rig.setAttribute('position', '0 0 -1');
                                rig.setAttribute('scale', '2 2 2');
                            } else {
                                rig.setAttribute('visible', false);
                            }
                        });
                        self.cyclingActive = false;
                        self.updateDebug('show: freeze rig0 center');
                        return;
                    }
                    if (self.sharkVideoPlane) {
                        var videoEl = document.getElementById('videoTexture');
                        var showPlane = function () {
                            self.sharkVideoPlane.setAttribute('visible', true);
                            if (self.sharkVideoShadow) self.sharkVideoShadow.setAttribute('visible', true);
                            var cycle = self.sharkVideoPlane.components['video-fact-cycle'];
                            if (cycle) cycle.playOnce();
                        };
                        var hidePlane = function () {
                            self.sharkVideoPlane.setAttribute('visible', false);
                            if (self.sharkVideoShadow) self.sharkVideoShadow.setAttribute('visible', false);
                        };

                        if (videoEl) {
                            if (videoEl.readyState >= 2) {
                                showPlane();
                            } else {
                                hidePlane();
                                videoEl.addEventListener('loadeddata', showPlane, { once: true });
                            }
                            var playPromise = videoEl.play();
                            if (playPromise && typeof playPromise.catch === 'function') {
                                playPromise.catch(function () {
                                    hidePlane();
                                });
                            }
                        } else {
                            hidePlane();
                        }
                    }
                    if (self.cyclingActive) return;
                    self.cyclingActive = true;
                    self.currentSharkIndex = 0;
                    self.animateNextShark();
                    self.updateDebug('show: cycling start');
                },
                hide: function () {
                    var self = this;
                    self.cyclingActive = false;
                    (self.sharkTimers || []).forEach(function (t) { if (t) clearTimeout(t); });
                    self.sharkTimers = [];
                    (self.sharkRigs || []).forEach(function (rig) {
                        if (!rig) return;
                        rig.removeAttribute('animation__swimPass');
                        rig.removeAttribute('animation__bob');
                        rig.setAttribute('visible', false);
                    });
                    if (self.sharkVideoPlane) {
                        self.sharkVideoPlane.setAttribute('visible', false);
                        if (self.sharkVideoShadow) self.sharkVideoShadow.setAttribute('visible', false);
                        var cycle = self.sharkVideoPlane.components['video-fact-cycle'];
                        if (cycle) cycle.stop();
                    }
                    self.updateDebug('hide');
                },
                animateNextShark: function () {
                    var self = this;
                    if (!self.cyclingActive) return;
                    var sharkIndex = self.currentSharkIndex % 2;
                    var rig = (self.sharkRigs || [])[sharkIndex];
                    if (!rig) return;

                    var startY = sharkIndex === 0 ? 0.50 : 0.35;
                    var startZ = sharkIndex === 0 ? 0.0 : -2.0;
                    var endZ = sharkIndex === 0 ? -2.0 : -4.0;
                    var passDuration = 3400;

                    rig.setAttribute('visible', true);
                    if (sharkIndex === 0) {
                        rig.setAttribute('rotation', '0 270 0');
                    } else {
                        rig.setAttribute('rotation', '0 0 0');
                    }
                    rig.setAttribute('position', `0 ${startY} ${startZ}`);
                    rig.setAttribute('animation__swimPass', {
                        property: 'position',
                        from: `0 ${startY} ${startZ}`,
                        to: `0 ${startY} ${endZ}`,
                        dur: passDuration,
                        easing: 'easeInOutSine'
                    });
                    rig.setAttribute('animation__bob', {
                        property: 'position',
                        from: `0 ${startY - 0.08} ${startZ}`,
                        to: `0 ${startY + 0.08} ${startZ}`,
                        dir: 'alternate',
                        dur: 500,
                        easing: 'easeInOutSine',
                        loop: true
                    });

                    var hideTimer = setTimeout(function () {
                        rig.removeAttribute('animation__swimPass');
                        rig.removeAttribute('animation__bob');
                        rig.setAttribute('visible', false);
                        self.currentSharkIndex = (self.currentSharkIndex + 1) % 2;
                        if (self.cyclingActive) {
                            var nextTimer = setTimeout(function () {
                                self.animateNextShark();
                            }, 220);
                            self.sharkTimers.push(nextTimer);
                        }
                    }, passDuration + 40);
                    self.sharkTimers.push(hideTimer);
                    self.updateDebug('animate idx=' + sharkIndex);
                },
                remove: function () {
                    this.hide();
                    if (this.updateVideoLayout) window.removeEventListener('resize', this.updateVideoLayout);
                }
            });
        }

        // ─── CONFIG ───
        const THRESHOLD = 0.55;
        const EMBEDDINGS_URL = './shark-embeddings-browser.json';
        const IMAGE_LIST_URL = './shark-image-list.json';
        const CACHE_KEY = 'shark-embeddings-v5';

        // ─── UI REFS ───
        const ui = {
            video: document.getElementById('video'),
            debugCanvas: document.getElementById('debug-canvas'),
            loading: document.getElementById('loading'),
            loadingStatus: document.getElementById('loading-status'),
            modelOverlay: document.getElementById('model-overlay'),
            sharkPlaneOverlay: document.getElementById('shark-plane-overlay'),
            sharkLabel: document.getElementById('shark-label'),
            labelName: document.getElementById('labelName'),
            startPlaneArBtn: document.getElementById('start-plane-ar-btn'),
            reanchorBtn: document.getElementById('reanchor-btn'),
            debugForceBtn: document.getElementById('debug-force-btn'),
            planeArOverlay: document.getElementById('plane-ar-overlay'),
            planeArHint: document.getElementById('plane-ar-hint'),
            rig0Tuner: document.getElementById('rig0-tuner'),
            rig0X: document.getElementById('rig0-x'),
            rig0Y: document.getElementById('rig0-y'),
            rig0Z: document.getElementById('rig0-z'),
            rig0XVal: document.getElementById('rig0-x-val'),
            rig0YVal: document.getElementById('rig0-y-val'),
            rig0ZVal: document.getElementById('rig0-z-val'),
            eventInfo: document.getElementById('event-info'),
            infoPanel: document.getElementById('info-panel')
        };

        const muralSceneEl = document.getElementById('mural-shark-scene');
        if (muralSceneEl) {
            muralSceneEl.addEventListener('render-target-loaded', function () {
                if (muralSceneEl.renderer) {
                    muralSceneEl.renderer.setClearColor(0x000000, 0);
                }
                if (muralSceneEl.canvas) {
                    muralSceneEl.canvas.style.background = 'transparent';
                }
                if (CAVEMAN_DEBUG && muralSceneEl.object3D && typeof THREE !== 'undefined') {
                    var existingWorldAxes = muralSceneEl.object3D.getObjectByName('debug-world-axes');
                    if (!existingWorldAxes) {
                        var worldAxes = new THREE.AxesHelper(1.2);
                        worldAxes.name = 'debug-world-axes';
                        worldAxes.position.set(0, 0, 0);
                        muralSceneEl.object3D.add(worldAxes);
                    }
                }
            });
        }

        // ─── STATE ───
        const STATE = {
            model: null,
            stream: null,
            running: false,
            enrolled: [],
            sharkGroups: {},
            lastMatchTime: 0,
            frameCount: 0,
            lastFpsTime: performance.now(),
            recentScores: [],
            ROLLING_N: 5,
            sharkVisible: false,
            dismissedAt: 0,
            currentEventIndex: 0,
            visitedStops: new Set(),
            planeArStarted: false
        };

        const PLANE_AR = {
            supported: false,
            session: null,
            renderer: null,
            scene: null,
            camera: null,
            refSpace: null,
            viewerSpace: null,
            hitTestSource: null,
            currentHitPose: null,
            reticle: null,
            sharkRoot: null,
            sharksPlaced: false,
            startedAt: 0
        };

        const RIG0_TUNER = { x: 0.00, y: 0.40, z: 0.00 };
        const RIG0_TUNER_Z_ORIGIN_SHIFT = -4.00;

        function applyRig0TunerPosition() {
            const muralSharkEl = document.getElementById('mural-shark-root');
            const comp = muralSharkEl && muralSharkEl.components && muralSharkEl.components['mural-shark-content'];
            const rig = comp && comp.sharkRigs ? comp.sharkRigs[0] : null;
            if (!rig) return;
            const zWorld = RIG0_TUNER.z + RIG0_TUNER_Z_ORIGIN_SHIFT;
            rig.setAttribute('visible', true);
            rig.setAttribute('position', `${RIG0_TUNER.x.toFixed(2)} ${RIG0_TUNER.y.toFixed(2)} ${zWorld.toFixed(2)}`);
            rig.setAttribute('rotation', '0 270 0');
            rig.setAttribute('scale', '0.85 0.85 0.85');
            if (comp.sharkRigs && comp.sharkRigs[1]) comp.sharkRigs[1].setAttribute('visible', false);
        }

        function setupRig0TunerUi() {
            if (!CAVEMAN_DEBUG || !CAVEMAN_RIG0_TUNER || !ui.rig0Tuner) return;
            ui.rig0Tuner.hidden = false;
            const sync = function () {
                RIG0_TUNER.x = Number(ui.rig0X.value);
                RIG0_TUNER.y = Number(ui.rig0Y.value);
                RIG0_TUNER.z = Number(ui.rig0Z.value);
                ui.rig0XVal.textContent = RIG0_TUNER.x.toFixed(2);
                ui.rig0YVal.textContent = RIG0_TUNER.y.toFixed(2);
                ui.rig0ZVal.textContent = RIG0_TUNER.z.toFixed(2);
                applyRig0TunerPosition();
            };
            [ui.rig0X, ui.rig0Y, ui.rig0Z].forEach(function (el) { if (el) el.addEventListener('input', sync); });
            sync();
        }

        // ─── EVENT DATA (from marker-demo) ───
        const dummyEvents = [
            {
                title: "The Big Game",
                date: "February 9, 2026",
                time: "3:30 PM PST",
                location: "SAP Center, San Jose",
                sharkeyMessage: "Hey there! I'm Sharkey, and this is where the magic happens! SAP Center hosts over 200 events per year. Arrive early to grab some teal gear!",
                icon: "./the-big-game.svg"
            },
            {
                title: "March Madness Watch Party",
                date: "March 15-April 6, 2026",
                time: "Various Times",
                location: "Downtown San Jose",
                sharkeyMessage: "Downtown SJ is buzzing! Over 40 restaurants and bars showing the games. San Pedro Square Market has the best viewing atmosphere!",
                icon: "./march-madness.svg"
            },
            {
                title: "World Cup Viewing",
                date: "June-July 2026",
                time: "Match Times Vary",
                location: "San Pedro Square Market",
                sharkeyMessage: "¡Hola! This historic market has been a gathering place since 1863. Try food from different countries while watching their teams play!",
                icon: "./world-cup.svg"
            }
        ];

        // ─── SOUND ───
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                if (type === 'found') {
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } else if (type === 'tap') {
                    oscillator.frequency.value = 1200;
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }
            } catch (e) { /* ignore audio errors */ }
        }

        // ─── EVENT UI (from marker-demo) ───
        function showEvent(event) {
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-date').innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>${event.date} &bull; ${event.time}`;
            document.getElementById('event-location').innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>${event.location}`;
            document.getElementById('sharkey-message').textContent = event.sharkeyMessage;
            document.getElementById('event-icon').src = event.icon;
            ui.eventInfo.classList.add('visible');

            STATE.visitedStops.add(STATE.currentEventIndex);
            updateProgress();
        }

        function hideEvent() {
            ui.eventInfo.classList.remove('visible');
        }

        function updateProgress() {
            STATE.visitedStops.forEach(index => {
                const stopItem = document.querySelector(`.stop-item[data-stop="${index}"]`);
                if (stopItem) {
                    stopItem.classList.add('visited');
                    const checkIcon = stopItem.querySelector('.check-icon');
                    if (checkIcon) {
                        checkIcon.innerHTML = '<circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>';
                    }
                }
            });
        }

        document.getElementById('learn-more').addEventListener('click', () => {
            playSound('tap');
            alert(`Ready to attend ${dummyEvents[STATE.currentEventIndex].title}?\n\nIn the full version, this would:\n- Show ticket options\n- Add to calendar\n- Share with friends\n- Get directions`);
            STATE.currentEventIndex = (STATE.currentEventIndex + 1) % dummyEvents.length;
            dismissAll();
        });

        document.getElementById('dismiss-event').addEventListener('click', () => {
            playSound('tap');
            dismissAll();
        });

        function setPlaneHint(text) {
            if (ui.planeArHint) ui.planeArHint.textContent = text;
        }

        function showFallbackSharks() {
            if (ui.sharkPlaneOverlay) ui.sharkPlaneOverlay.classList.add('visible');
            const muralSharkEl = document.getElementById('mural-shark-root');
            if (muralSharkEl && muralSharkEl.components && muralSharkEl.components['mural-shark-content']) {
                muralSharkEl.components['mural-shark-content'].show();
            }
        }

        function hideFallbackSharks() {
            const muralSharkEl = document.getElementById('mural-shark-root');
            if (muralSharkEl && muralSharkEl.components && muralSharkEl.components['mural-shark-content']) {
                muralSharkEl.components['mural-shark-content'].hide();
            }
            if (ui.sharkPlaneOverlay) ui.sharkPlaneOverlay.classList.remove('visible');
        }

        async function setupPlaneArSupport() {
            if (!ui.startPlaneArBtn) return;
            if (!navigator.xr || !window.THREE || !THREE.GLTFLoader) {
                ui.startPlaneArBtn.textContent = 'Plane AR Unsupported';
                ui.startPlaneArBtn.disabled = true;
                return;
            }
            try {
                PLANE_AR.supported = await navigator.xr.isSessionSupported('immersive-ar');
            } catch (e) {
                PLANE_AR.supported = false;
            }
            if (!PLANE_AR.supported) {
                ui.startPlaneArBtn.textContent = 'Plane AR Unsupported';
                ui.startPlaneArBtn.disabled = true;
                return;
            }
            ui.startPlaneArBtn.disabled = false;
            ui.startPlaneArBtn.textContent = 'Start Plane AR';
        }

        async function loadGltf(loader, url) {
            return new Promise((resolve, reject) => {
                loader.load(url, resolve, undefined, reject);
            });
        }

        async function ensurePlaneArScene() {
            if (PLANE_AR.renderer) return;
            PLANE_AR.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            PLANE_AR.renderer.setPixelRatio(window.devicePixelRatio || 1);
            PLANE_AR.renderer.setSize(window.innerWidth, window.innerHeight);
            PLANE_AR.renderer.xr.enabled = true;
            if (ui.planeArOverlay) ui.planeArOverlay.appendChild(PLANE_AR.renderer.domElement);

            PLANE_AR.scene = new THREE.Scene();
            PLANE_AR.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 40);
            PLANE_AR.scene.add(new THREE.HemisphereLight(0xffffff, 0x667788, 1.4));
            const keyLight = new THREE.DirectionalLight(0xffffff, 1.0);
            keyLight.position.set(1, 2, 1);
            PLANE_AR.scene.add(keyLight);

            const reticleGeo = new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI / 2);
            const reticleMat = new THREE.MeshBasicMaterial({ color: 0x00a9e0, transparent: true, opacity: 0.9 });
            PLANE_AR.reticle = new THREE.Mesh(reticleGeo, reticleMat);
            PLANE_AR.reticle.matrixAutoUpdate = false;
            PLANE_AR.reticle.visible = false;
            PLANE_AR.scene.add(PLANE_AR.reticle);

            PLANE_AR.sharkRoot = new THREE.Group();
            PLANE_AR.sharkRoot.visible = false;
            PLANE_AR.scene.add(PLANE_AR.sharkRoot);

            const loader = new THREE.GLTFLoader();
            const sharkDefs = [
                { url: './MARIA_SHARK_ANIMATED.glb', scale: 0.35, x: -0.6, y: 0.0, z: -0.35 },
                { url: './SHAUN_SHARK_ANIMATED.glb', scale: 0.35, x: 0.6, y: 0.0, z: 0.35 }
            ];
            for (const def of sharkDefs) {
                try {
                    const gltf = await loadGltf(loader, def.url);
                    const mesh = gltf.scene;
                    mesh.scale.setScalar(def.scale);
                    mesh.position.set(def.x, def.y, def.z);
                    PLANE_AR.sharkRoot.add(mesh);
                } catch (e) {
                    console.warn('Failed to load', def.url, e);
                }
            }

            window.addEventListener('resize', () => {
                if (!PLANE_AR.renderer || !PLANE_AR.camera) return;
                PLANE_AR.camera.aspect = window.innerWidth / window.innerHeight;
                PLANE_AR.camera.updateProjectionMatrix();
                PLANE_AR.renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function placeSharksAtPose(pose) {
            if (!PLANE_AR.sharkRoot || !pose) return;
            const matrix = new THREE.Matrix4().fromArray(pose.transform.matrix);
            matrix.decompose(PLANE_AR.sharkRoot.position, PLANE_AR.sharkRoot.quaternion, PLANE_AR.sharkRoot.scale);
            PLANE_AR.sharkRoot.scale.setScalar(1);
            PLANE_AR.sharkRoot.visible = true;
            PLANE_AR.sharksPlaced = true;
            setPlaneHint('Sharks anchored to surface');
        }

        function clearPlanePlacement() {
            PLANE_AR.sharksPlaced = false;
            if (PLANE_AR.sharkRoot) PLANE_AR.sharkRoot.visible = false;
            setPlaneHint('Move phone slowly to find a surface');
        }

        function onPlaneArFrame(time, frame) {
            const session = PLANE_AR.session;
            if (!session || !PLANE_AR.renderer || !PLANE_AR.scene || !PLANE_AR.camera) return;
            if (frame && PLANE_AR.hitTestSource && PLANE_AR.refSpace) {
                const hitResults = frame.getHitTestResults(PLANE_AR.hitTestSource);
                if (hitResults.length > 0) {
                    const hit = hitResults[0];
                    const pose = hit.getPose(PLANE_AR.refSpace);
                    PLANE_AR.currentHitPose = pose;
                    if (PLANE_AR.reticle && pose) {
                        PLANE_AR.reticle.visible = true;
                        PLANE_AR.reticle.matrix.fromArray(pose.transform.matrix);
                    }
                    if (!PLANE_AR.sharksPlaced) setPlaneHint('Surface found - tap screen to place sharks');
                } else {
                    PLANE_AR.currentHitPose = null;
                    if (PLANE_AR.reticle) PLANE_AR.reticle.visible = false;
                }
            }

            if (PLANE_AR.sharkRoot && PLANE_AR.sharksPlaced) {
                const t = (time - PLANE_AR.startedAt) / 1000;
                PLANE_AR.sharkRoot.rotation.y += 0.003;
                PLANE_AR.sharkRoot.children.forEach((child, i) => {
                    child.position.y = (i === 0 ? 0 : 0.05) + Math.sin(t * 2.0 + i) * 0.04;
                    child.rotation.y += 0.005 * (i % 2 === 0 ? 1 : -1);
                });
            }

            PLANE_AR.renderer.render(PLANE_AR.scene, PLANE_AR.camera);
        }

        async function stopPlaneArSession() {
            if (PLANE_AR.session) {
                await PLANE_AR.session.end();
            }
        }

        function onPlaneArEnded() {
            PLANE_AR.session = null;
            PLANE_AR.refSpace = null;
            PLANE_AR.viewerSpace = null;
            PLANE_AR.hitTestSource = null;
            PLANE_AR.currentHitPose = null;
            PLANE_AR.sharksPlaced = false;
            if (PLANE_AR.reticle) PLANE_AR.reticle.visible = false;
            if (PLANE_AR.sharkRoot) PLANE_AR.sharkRoot.visible = false;
            if (PLANE_AR.renderer) PLANE_AR.renderer.setAnimationLoop(null);
            if (ui.planeArOverlay) ui.planeArOverlay.classList.remove('visible');
            if (ui.reanchorBtn) ui.reanchorBtn.style.display = 'none';
            if (ui.startPlaneArBtn) ui.startPlaneArBtn.textContent = 'Start Plane AR';
            STATE.planeArStarted = false;
            setPlaneHint('Move phone slowly to find a surface');
        }

        async function startPlaneArSession() {
            if (PLANE_AR.session) {
                await stopPlaneArSession();
                return;
            }
            if (!PLANE_AR.supported) return;

            await ensurePlaneArScene();
            try {
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['local-floor', 'anchors', 'plane-detection', 'dom-overlay'],
                    domOverlay: { root: document.body }
                });
                PLANE_AR.session = session;
                STATE.planeArStarted = true;
                PLANE_AR.startedAt = performance.now();
                if (ui.planeArOverlay) ui.planeArOverlay.classList.add('visible');
                if (ui.reanchorBtn) ui.reanchorBtn.style.display = 'inline-block';
                if (ui.startPlaneArBtn) ui.startPlaneArBtn.textContent = 'Stop Plane AR';
                setPlaneHint('Move phone slowly to find a surface');

                PLANE_AR.renderer.xr.setSession(session);
                PLANE_AR.refSpace = await session.requestReferenceSpace('local');
                PLANE_AR.viewerSpace = await session.requestReferenceSpace('viewer');
                PLANE_AR.hitTestSource = await session.requestHitTestSource({ space: PLANE_AR.viewerSpace });

                session.addEventListener('end', onPlaneArEnded);
                session.addEventListener('select', () => {
                    if (PLANE_AR.currentHitPose) placeSharksAtPose(PLANE_AR.currentHitPose);
                });

                PLANE_AR.renderer.setAnimationLoop(onPlaneArFrame);
            } catch (e) {
                console.error('Unable to start plane AR:', e);
                onPlaneArEnded();
            }
        }

        if (ui.startPlaneArBtn) {
            ui.startPlaneArBtn.addEventListener('click', () => {
                startPlaneArSession();
            });
        }
        if (ui.reanchorBtn) {
            ui.reanchorBtn.addEventListener('click', () => {
                clearPlanePlacement();
            });
        }
        if (ui.debugForceBtn) {
            ui.debugForceBtn.addEventListener('click', () => {
                playSound('tap');
                if (PLANE_AR.session && PLANE_AR.currentHitPose) {
                    placeSharksAtPose(PLANE_AR.currentHitPose);
                    return;
                }
                if (!STATE.sharkVisible) onSharkFound('Debug Force', 1.0);
            });
        }

        // ─── EMBEDDING FUNCTIONS ───
        function l2Normalize(vec) {
            let sum = 0;
            for (let i = 0; i < vec.length; i++) sum += vec[i] * vec[i];
            const norm = Math.sqrt(sum);
            if (norm === 0) return vec;
            const out = new Float32Array(vec.length);
            for (let i = 0; i < vec.length; i++) out[i] = vec[i] / norm;
            return out;
        }

        function cosineSimilarity(a, b) {
            let dot = 0;
            for (let i = 0; i < a.length; i++) dot += a[i] * b[i];
            return dot;
        }

        function friendlyName(filename) {
            const m = filename.match(/shark(\d+)/i);
            return m ? `Shark ${parseInt(m[1])}` : filename.replace(/\.[^.]+$/, '');
        }

        function bestMatch(embedding) {
            const sharkScores = {};
            for (const item of STATE.enrolled) {
                const score = cosineSimilarity(embedding, item.embedding);
                const sharkId = friendlyName(item.name);
                if (!sharkScores[sharkId] || score > sharkScores[sharkId].score) {
                    sharkScores[sharkId] = { name: item.name, score };
                }
            }
            let best = { name: null, score: -1 };
            for (const key of Object.keys(sharkScores)) {
                if (sharkScores[key].score > best.score) best = sharkScores[key];
            }
            return best;
        }

        function rollingScore(currentMatch) {
            STATE.recentScores.push({ name: currentMatch.name, score: currentMatch.score });
            if (STATE.recentScores.length > STATE.ROLLING_N) STATE.recentScores.shift();

            const counts = {};
            let topName = null;
            let topCount = 0;
            for (const entry of STATE.recentScores) {
                if (!entry.name) continue;
                counts[entry.name] = (counts[entry.name] || 0) + 1;
                if (counts[entry.name] > topCount) {
                    topCount = counts[entry.name];
                    topName = entry.name;
                }
            }

            let sum = 0, n = 0;
            for (const entry of STATE.recentScores) {
                if (entry.name === topName) { sum += entry.score; n++; }
            }
            return { name: topName, score: n > 0 ? sum / n : 0, confidence: topCount / STATE.ROLLING_N };
        }

        function buildSharkGroups() {
            STATE.sharkGroups = {};
            for (const item of STATE.enrolled) {
                const id = friendlyName(item.name);
                if (!STATE.sharkGroups[id]) STATE.sharkGroups[id] = [];
                STATE.sharkGroups[id].push(item);
            }
        }

        function applyEmbeddings(data) {
            STATE.enrolled = data.map(item => ({
                name: item.name,
                embedding: new Float32Array(item.embedding)
            }));
            buildSharkGroups();
            const sharkCount = Object.keys(STATE.sharkGroups).length;
            console.log(`${sharkCount} sharks loaded`);
        }

        // ─── SILENT FALLBACK HELPERS ───
        function cropAndEmbed(imgEl, sx, sy, sw, sh) {
            const canvas = document.createElement('canvas');
            canvas.width = 224;
            canvas.height = 224;
            canvas.getContext('2d').drawImage(imgEl, sx, sy, sw, sh, 0, 0, 224, 224);
            return tf.tidy(() => {
                const t = tf.browser.fromPixels(canvas);
                return STATE.model.infer(t, true);
            });
        }

        async function silentComputeEmbeddings() {
            const resp = await fetch(IMAGE_LIST_URL);
            if (!resp.ok) return false;
            const imageList = await resp.json();
            const results = [];
            for (const imgPath of imageList) {
                const fileName = imgPath.split('/').pop();
                const img = new Image();
                img.crossOrigin = 'anonymous';
                await new Promise(r => { img.onload = r; img.onerror = r; img.src = './' + imgPath; });
                if (!img.naturalWidth) continue;
                const w = img.naturalWidth, h = img.naturalHeight, m = Math.min(w, h);
                const cx = (w - m) / 2, cy = (h - m) / 2;
                const crops = [[cx,cy,m,m],[0,0,m,m],[w-m,0,m,m],[0,h-m,m,m],[w-m,h-m,m,m]];
                for (const [sx,sy,sw,sh] of crops) {
                    const emb = cropAndEmbed(img, sx, sy, sw, sh);
                    const data = await emb.data();
                    emb.dispose();
                    results.push({ name: fileName, embedding: Array.from(l2Normalize(new Float32Array(data))) });
                }
            }
            if (results.length === 0) return false;
            try { localStorage.setItem(CACHE_KEY, JSON.stringify(results)); } catch (e) {}
            applyEmbeddings(results);
            return true;
        }

        // ─── LOADING ───
        async function loadEmbeddings() {
            ui.loadingStatus.textContent = 'Almost ready...';

            // 1. Try static JSON file (normal path)
            try {
                const resp = await fetch(EMBEDDINGS_URL);
                if (resp.ok) {
                    const data = await resp.json();
                    if (data && data.length > 0) { applyEmbeddings(data); return; }
                }
            } catch (e) {}

            // 2. Try localStorage cache
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    if (data && data.length > 0) { applyEmbeddings(data); return; }
                }
            } catch (e) {}

            // 3. Silent in-browser computation (user sees nothing different)
            const ok = await silentComputeEmbeddings();
            if (!ok) throw new Error('Unable to load shark data');
        }

        async function loadModel() {
            ui.loadingStatus.textContent = 'Preparing camera...';
            await tf.ready();
            STATE.model = await mobilenet.load({ version: 2, alpha: 1.0 });
        }

        async function startCamera() {
            ui.loadingStatus.textContent = 'Starting camera...';
            STATE.stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            ui.video.srcObject = STATE.stream;
            await new Promise(r => { ui.video.onloadedmetadata = r; });
        }

        async function getFrameEmbedding() {
            const vw = ui.video.videoWidth;
            const vh = ui.video.videoHeight;
            const minDim = Math.min(vw, vh);
            const sx = (vw - minDim) / 2;
            const sy = (vh - minDim) / 2;
            const ctx = ui.debugCanvas.getContext('2d', { willReadFrequently: true });
            ctx.drawImage(ui.video, sx, sy, minDim, minDim, 0, 0, 224, 224);
            const emb = tf.tidy(() => {
                const t = tf.browser.fromPixels(ui.debugCanvas);
                return STATE.model.infer(t, true);
            });
            const data = await emb.data();
            emb.dispose();
            return l2Normalize(new Float32Array(data));
        }

        // ─── SHARK FOUND / LOST ───
        function onSharkFound(name, score) {
            if (STATE.sharkVisible) return; // already showing
            STATE.sharkVisible = true;
            STATE.lastMatchTime = performance.now();

            // Prefer plane-anchored sharks when WebXR session is active.
            if (PLANE_AR.session) {
                if (PLANE_AR.currentHitPose && !PLANE_AR.sharksPlaced) placeSharksAtPose(PLANE_AR.currentHitPose);
                if (!PLANE_AR.sharksPlaced) setPlaneHint('Find a surface and tap to place sharks');
            } else {
                showFallbackSharks();
            }

            // Show label
            ui.labelName.textContent = 'Sharks Activated';
            ui.sharkLabel.classList.add('visible');

            // Show event info + sound
            showEvent(dummyEvents[STATE.currentEventIndex]);
            playSound('found');

        }

        function onSharkLost() {
            // Do nothing — shark stays until user dismisses
        }

        function dismissAll() {
            STATE.sharkVisible = false;
            STATE.dismissedAt = performance.now();
            STATE.recentScores = [];
            ui.sharkLabel.classList.remove('visible');
            hideFallbackSharks();
            if (PLANE_AR.session) clearPlanePlacement();
            hideEvent();
        }

        // ─── MAIN LOOP ───
        async function loop() {
            if (!STATE.running) return;

            try {
                if (!STATE.model || !STATE.stream || STATE.enrolled.length === 0) {
                    requestAnimationFrame(loop);
                    return;
                }

                const embedding = await getFrameEmbedding();
                const rawMatch = bestMatch(embedding);
                const smoothed = rollingScore(rawMatch);

                const cooldownOver = performance.now() - STATE.dismissedAt > 3000;
                if (cooldownOver && smoothed.name && smoothed.score >= THRESHOLD && smoothed.confidence >= 0.4) {
                    STATE.lastMatchTime = performance.now();
                    onSharkFound(smoothed.name, smoothed.score);
                } else {
                    onSharkLost();
                }
            } catch (e) {
                console.error('Loop error:', e);
            }

            requestAnimationFrame(loop);
        }

        // ─── INIT ───
        async function init() {
            try {
                await loadModel();
                await loadEmbeddings();
                await startCamera();
                await setupPlaneArSupport();
                setupRig0TunerUi();

                ui.loading.classList.add('hidden');

                STATE.running = true;
                loop();
            } catch (e) {
                ui.loadingStatus.textContent = 'Something went wrong. Please refresh.';
                console.error(e);
            }
        }

        init();
    </script>
</body>
</html>
